<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Minimalistic arduino communication: Led graph bar and image processing - PART 1 | Random code generator</title>
<meta name="generator" content="Jekyll v3.8.3" />
<meta property="og:title" content="Minimalistic arduino communication: Led graph bar and image processing - PART 1" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I have been using the esp8266 for a while and exploring the use of least possible add-ons(to minimize costs) while interacting with it. The esp8266 has different modes of operation, the most common being access point and client. A typical usage scenario while using the esp8266 would be to set it in access point mode, no password set, connect to it and submit a form with the ssid and password for the network it should join. In my scenario, the esp8266 works only in access point mode and the user connects to it. I could use a fixed password, but I want a randomly generated password each time the esp8266 turns on. I could opt to use a display, but this will probably be more expensive." />
<meta property="og:description" content="I have been using the esp8266 for a while and exploring the use of least possible add-ons(to minimize costs) while interacting with it. The esp8266 has different modes of operation, the most common being access point and client. A typical usage scenario while using the esp8266 would be to set it in access point mode, no password set, connect to it and submit a form with the ssid and password for the network it should join. In my scenario, the esp8266 works only in access point mode and the user connects to it. I could use a fixed password, but I want a randomly generated password each time the esp8266 turns on. I could opt to use a display, but this will probably be more expensive." />
<link rel="canonical" href="http://localhost:4000/led-camera-decoding-part-one/" />
<meta property="og:url" content="http://localhost:4000/led-camera-decoding-part-one/" />
<meta property="og:site_name" content="Random code generator" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-08-19T21:00:00+02:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Minimalistic arduino communication: Led graph bar and image processing - PART 1","dateModified":"2018-08-19T21:00:00+02:00","datePublished":"2018-08-19T21:00:00+02:00","url":"http://localhost:4000/led-camera-decoding-part-one/","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/led-camera-decoding-part-one/"},"description":"I have been using the esp8266 for a while and exploring the use of least possible add-ons(to minimize costs) while interacting with it. The esp8266 has different modes of operation, the most common being access point and client. A typical usage scenario while using the esp8266 would be to set it in access point mode, no password set, connect to it and submit a form with the ssid and password for the network it should join. In my scenario, the esp8266 works only in access point mode and the user connects to it. I could use a fixed password, but I want a randomly generated password each time the esp8266 turns on. I could opt to use a display, but this will probably be more expensive.","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Random code generator" /></head>
<script src="http://localhost:4000/assets/javascript/jquery-3.3.1.js"></script>
  <script src="http://localhost:4000/assets/javascript/fontawesome-all.js"></script>
  <script src="http://localhost:4000/assets/javascript/popper.js"></script>
  <script src="http://localhost:4000/assets/javascript/bootstrap.js"></script>
  <script src="http://localhost:4000/assets/javascript/bootstrap-sprockets.js"></script>

  <body><header class="site-header" role="banner">

  <nav class="navbar navbar-expand-md navbar-light bg-faded"><a class="site-title" rel="author" href="/">Random code generator</a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto justify-content-around"><li class="nav-item">
                <a class="nav-link active" href="/about/">About</a>
              </li></ul>
      </div></nav>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Minimalistic arduino communication: Led graph bar and image processing - PART 1</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2018-08-19T21:00:00+02:00" itemprop="datePublished">Aug 19, 2018
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I have been using the esp8266 for a while and exploring the use of least possible add-ons(to minimize costs) while interacting with it. The esp8266 has different modes of operation, the most common being access point and client. A typical usage scenario while using the esp8266 would be to set it in access point mode, no password set, connect to it and submit a form with the ssid and password for the network it should join. In my scenario, the esp8266 works only in access point mode and the user connects to it. I could use a fixed password, but I want a randomly generated password each time the esp8266 turns on. I could opt to use a display, but this will probably be more expensive.</p>

<p>I started to think about different ways to communicate and came up with a couple of ideas. The first of these is to use a blinking led graph bar to send the password to a phone via the camera. In theory, this seems reasonable, most phones have cameras capable of recording video at 30 fps. There are 2 parts required to get this to work, image processing to identify the state of the leds and a microcontroller with blinking leds. Since encoding characters into on/off leds is simple, I decided to get started with the image processing. Having an android phone, I’ll be using Java.</p>

<p>My first implementation was very basic. Loop through the image, have an additional array of visited points and when finding a color match from the rgb colors array do a graph like traveral. In this traversal I go in all directions iteratively by using a queue, checking if the point has been visited or not. I also added a local visited array when doing the traversal to avoid repeated traversals without modifying the global visited array, although this may not be necessary. I tested two ways of calculating the color distance; Manhattan distance and Euclidean distance. By avoiding Math.pow and Math.sqrt I thought I would be able to improve the performance of my blob detector, but my results when running on my machine showed me otherwise. The cold runtime for one color was around 40ms, while that for 3 colors was around 80ms. At 80ms the best I can do is 12.5 FPS, so this one is not good enough.</p>

<p>Sample image:
<img src="/assets/images/led_graph_bar/sample.png" alt="Sample Image" /></p>

<p>Result (Matching colors are [0,255,195],[0,0,255],[255,0,0]):</p>

<p><img src="/assets/images/led_graph_bar/BlobFinder.png" alt="Sample Image" /></p>

<p>I have helper class ImageHandler, which has some code to draw the red rectangles on the found blobs.</p>

<p>My first implementation of blob detection is the following:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BlobFinder</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">minSize</span> <span class="o">=</span> <span class="mi">50</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">double</span> <span class="n">maxColorDistance</span> <span class="o">=</span> <span class="mi">50</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">rgbColors</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">background</span> <span class="o">=</span> <span class="mh">0xffffff</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">ImageHandler</span> <span class="n">handler</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">BlobFinder</span><span class="o">(</span><span class="n">ImageHandler</span> <span class="n">handler</span><span class="o">){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="nf">BlobFinder</span><span class="o">(</span><span class="n">ImageHandler</span> <span class="n">handler</span><span class="o">,</span> <span class="kt">int</span><span class="o">[][]</span> <span class="n">rgbColors</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">rgbColors</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">rgbColors</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">3</span><span class="o">){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Error"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">rgbColors</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">rgbColors</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="nl">colorArr:</span> <span class="n">rgbColors</span><span class="o">){</span>
            <span class="k">this</span><span class="o">.</span><span class="na">rgbColors</span><span class="o">[</span><span class="n">count</span><span class="o">]</span> <span class="o">=</span> <span class="n">rgbArrayToInt</span><span class="o">(</span><span class="n">colorArr</span><span class="o">);</span>
            <span class="n">count</span><span class="o">++;</span>
        <span class="o">}</span>

        <span class="k">this</span><span class="o">.</span><span class="na">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="nf">BlobFinder</span><span class="o">(</span><span class="n">ImageHandler</span> <span class="n">handler</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">rgbColors</span><span class="o">){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">rgbColors</span> <span class="o">=</span> <span class="n">rgbColors</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="nf">BlobFinder</span><span class="o">(</span><span class="n">ImageHandler</span> <span class="n">handler</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">rgbColors</span><span class="o">,</span> <span class="kt">int</span> <span class="n">minSize</span><span class="o">){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">rgbColors</span> <span class="o">=</span> <span class="n">rgbColors</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">minSize</span> <span class="o">=</span> <span class="n">minSize</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Blob</span><span class="o">&gt;</span> <span class="nf">getBlobs</span><span class="o">(){</span>
        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Blob</span><span class="o">&gt;</span> <span class="n">blobs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Blob</span><span class="o">&gt;();</span>
        <span class="n">BufferedImage</span> <span class="n">img</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="na">getInputImage</span><span class="o">();</span>
        <span class="kt">int</span><span class="o">[][]</span> <span class="n">visited</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">img</span><span class="o">.</span><span class="na">getHeight</span><span class="o">()][</span><span class="n">img</span><span class="o">.</span><span class="na">getWidth</span><span class="o">()];</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">img</span><span class="o">.</span><span class="na">getHeight</span><span class="o">();</span><span class="n">i</span><span class="o">++){</span>      <span class="c1">//y</span>
            <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">img</span><span class="o">.</span><span class="na">getWidth</span><span class="o">();</span><span class="n">j</span><span class="o">++){</span>  <span class="c1">//x</span>
                <span class="kt">int</span> <span class="n">pixelVisited</span> <span class="o">=</span> <span class="n">visited</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">];</span>
                <span class="k">if</span><span class="o">(</span><span class="n">pixelVisited</span> <span class="o">==</span> <span class="mi">1</span><span class="o">){</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="kt">int</span> <span class="n">pixel</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="na">getRGB</span><span class="o">(</span><span class="n">j</span><span class="o">,</span><span class="n">i</span><span class="o">);</span>
                <span class="k">if</span><span class="o">(</span><span class="n">pixel</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">){</span>
                    <span class="n">visited</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="kt">double</span> <span class="n">bgDistance</span> <span class="o">=</span> <span class="n">rgbDistance</span><span class="o">(</span><span class="n">background</span><span class="o">,</span><span class="n">pixel</span><span class="o">);</span>
                <span class="k">if</span><span class="o">(</span><span class="n">bgDistance</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="o">){</span>
                    <span class="n">visited</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="kt">int</span> <span class="n">foundColor</span> <span class="o">=</span> <span class="n">background</span><span class="o">;</span>
                <span class="k">if</span><span class="o">(</span><span class="n">rgbColors</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                    <span class="kt">double</span> <span class="n">minDistance</span> <span class="o">=</span> <span class="n">maxColorDistance</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
                    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="nl">color:</span> <span class="n">rgbColors</span><span class="o">){</span>
                        <span class="kt">double</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">rgbDistance</span><span class="o">(</span><span class="n">color</span><span class="o">,</span> <span class="n">pixel</span><span class="o">);</span>
                        <span class="k">if</span><span class="o">(</span><span class="n">temp</span> <span class="o">&lt;</span> <span class="n">minDistance</span><span class="o">){</span>
                            <span class="n">foundColor</span> <span class="o">=</span> <span class="n">color</span><span class="o">;</span>
                            <span class="n">minDistance</span> <span class="o">=</span> <span class="n">temp</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">minDistance</span> <span class="o">&gt;</span> <span class="n">maxColorDistance</span><span class="o">){</span>
                        <span class="n">visited</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">Blob</span> <span class="n">newBlob</span> <span class="o">=</span> <span class="n">getBlob</span><span class="o">(</span><span class="n">img</span><span class="o">,</span> <span class="n">visited</span><span class="o">,</span><span class="n">j</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">foundColor</span><span class="o">);</span>
                <span class="k">if</span><span class="o">(</span><span class="n">newBlob</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                    <span class="n">blobs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">newBlob</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">blobs</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="n">Blob</span> <span class="nf">getBlob</span><span class="o">(</span><span class="n">BufferedImage</span> <span class="n">img</span><span class="o">,</span> <span class="kt">int</span><span class="o">[][]</span> <span class="n">visited</span><span class="o">,</span> <span class="kt">int</span> <span class="n">x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">y</span><span class="o">,</span> <span class="kt">int</span> <span class="n">matchColor</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">max_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">min_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">y</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">min_y</span> <span class="o">=</span> <span class="n">y</span><span class="o">;</span>
        <span class="n">Random</span> <span class="n">rand</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">rr</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">255</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">rg</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">255</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">rb</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">255</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">base_color</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">if</span><span class="o">(</span><span class="n">matchColor</span> <span class="o">==</span> <span class="n">background</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">base_color</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="na">getRGB</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">base_color</span> <span class="o">=</span> <span class="n">matchColor</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">Queue</span> <span class="o">&lt;</span><span class="n">Pair</span> <span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span>
        <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Pair</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">));</span>
        <span class="kt">int</span><span class="o">[][]</span> <span class="n">visitedBlob</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">img</span><span class="o">.</span><span class="na">getHeight</span><span class="o">()][</span><span class="n">img</span><span class="o">.</span><span class="na">getWidth</span><span class="o">()];</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">while</span><span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">peek</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">Pair</span> <span class="n">current</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">_x</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">current</span><span class="o">.</span><span class="na">getLeft</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">_y</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">current</span><span class="o">.</span><span class="na">getRight</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">visitedBlob</span><span class="o">[</span><span class="n">_y</span><span class="o">][</span><span class="n">_x</span><span class="o">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">visited</span><span class="o">[</span><span class="n">_y</span><span class="o">][</span><span class="n">_x</span><span class="o">]</span> <span class="o">==</span> <span class="mi">1</span><span class="o">){</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">visitedBlob</span><span class="o">[</span><span class="n">_y</span><span class="o">][</span><span class="n">_x</span><span class="o">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">pixel</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="na">getRGB</span><span class="o">(</span><span class="n">_x</span><span class="o">,</span><span class="n">_y</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span><span class="n">rgbDistance</span><span class="o">(</span><span class="n">base_color</span><span class="o">,</span><span class="n">pixel</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">maxColorDistance</span><span class="o">){</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">size</span><span class="o">++;</span>
            <span class="n">visited</span><span class="o">[</span><span class="n">_y</span><span class="o">][</span><span class="n">_x</span><span class="o">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="o">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)%</span><span class="mi">255</span><span class="o">;</span>
            <span class="k">if</span><span class="o">(</span><span class="n">_x</span> <span class="o">&lt;</span> <span class="n">min_x</span><span class="o">){</span>
                <span class="n">min_x</span> <span class="o">=</span> <span class="n">_x</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span><span class="o">(</span><span class="n">_x</span> <span class="o">&gt;</span> <span class="n">max_x</span><span class="o">){</span>
                <span class="n">max_x</span> <span class="o">=</span> <span class="n">_x</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span><span class="o">(</span><span class="n">_y</span> <span class="o">&lt;</span> <span class="n">min_y</span><span class="o">){</span>
                <span class="n">min_y</span> <span class="o">=</span> <span class="n">_y</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span><span class="o">(</span><span class="n">_y</span> <span class="o">&gt;</span> <span class="n">max_y</span><span class="o">){</span>
                <span class="n">max_y</span> <span class="o">=</span> <span class="n">_y</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span><span class="o">(</span><span class="n">_x</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">visitedBlob</span><span class="o">[</span><span class="n">_y</span><span class="o">][</span><span class="n">_x</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="o">){</span>
                <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Pair</span><span class="o">((</span><span class="n">_x</span> <span class="o">-</span> <span class="mi">1</span><span class="o">),</span><span class="n">_y</span><span class="o">));</span>
            <span class="o">}</span>
            <span class="k">if</span><span class="o">(</span><span class="n">_x</span> <span class="o">&lt;</span> <span class="o">(</span><span class="n">img</span><span class="o">.</span><span class="na">getWidth</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">visitedBlob</span><span class="o">[</span><span class="n">_y</span><span class="o">][</span><span class="n">_x</span> <span class="o">+</span> <span class="mi">1</span><span class="o">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="o">){</span>
                <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Pair</span><span class="o">((</span><span class="n">_x</span> <span class="o">+</span> <span class="mi">1</span><span class="o">),</span><span class="n">_y</span><span class="o">));</span>
            <span class="o">}</span>
            <span class="k">if</span><span class="o">(</span><span class="n">_y</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">visitedBlob</span><span class="o">[</span><span class="n">_y</span> <span class="o">-</span> <span class="mi">1</span><span class="o">][</span><span class="n">_x</span><span class="o">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="o">){</span>
                <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Pair</span><span class="o">(</span><span class="n">_x</span> <span class="o">,(</span><span class="n">_y</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)));</span>
            <span class="o">}</span>
            <span class="k">if</span><span class="o">(</span><span class="n">_y</span> <span class="o">&lt;</span> <span class="o">(</span><span class="n">img</span><span class="o">.</span><span class="na">getHeight</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">visitedBlob</span><span class="o">[</span><span class="n">_y</span> <span class="o">+</span> <span class="mi">1</span><span class="o">][</span><span class="n">_x</span><span class="o">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="o">){</span>
                <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Pair</span><span class="o">(</span><span class="n">_x</span><span class="o">,</span><span class="n">_y</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">minSize</span><span class="o">){</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">Blob</span> <span class="n">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Blob</span><span class="o">();</span>
        <span class="n">blob</span><span class="o">.</span><span class="na">setRgb</span><span class="o">(</span><span class="n">intToRgbArray</span><span class="o">(</span><span class="n">base_color</span><span class="o">));</span>
        <span class="kt">int</span> <span class="n">posx</span> <span class="o">=</span> <span class="o">(</span><span class="n">max_x</span><span class="o">-</span><span class="n">min_x</span><span class="o">)/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">min_x</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">posy</span> <span class="o">=</span> <span class="o">(</span><span class="n">max_y</span><span class="o">-</span><span class="n">min_y</span><span class="o">)/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">min_y</span><span class="o">;</span>
        <span class="n">blob</span><span class="o">.</span><span class="na">setPosition</span><span class="o">(</span><span class="n">posx</span><span class="o">,</span> <span class="n">posy</span><span class="o">);</span>
        <span class="n">blob</span><span class="o">.</span><span class="na">setHeight</span><span class="o">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="o">);</span>
        <span class="n">blob</span><span class="o">.</span><span class="na">setWidth</span><span class="o">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">blob</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">rgbArrayToInt</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">rgb</span><span class="o">){</span>
        <span class="kt">int</span> <span class="n">color</span> <span class="o">=</span> <span class="o">(</span><span class="n">rgb</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="o">)</span> <span class="o">|</span> <span class="o">(</span><span class="n">rgb</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="o">)</span> <span class="o">|</span> <span class="n">rgb</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>
        <span class="k">return</span> <span class="n">color</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">int</span><span class="o">[]</span> <span class="nf">intToRgbArray</span><span class="o">(</span><span class="kt">int</span> <span class="n">rgb</span><span class="o">){</span>
        <span class="kt">int</span>  <span class="n">red</span>   <span class="o">=</span> <span class="o">(</span><span class="n">rgb</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="o">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="o">;</span>
        <span class="kt">int</span>  <span class="n">green</span> <span class="o">=</span> <span class="o">(</span><span class="n">rgb</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="o">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="o">;</span>
        <span class="kt">int</span>  <span class="n">blue</span>  <span class="o">=</span>  <span class="n">rgb</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="o">;</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">rgbArr</span> <span class="o">=</span> <span class="o">{</span><span class="n">red</span><span class="o">,</span> <span class="n">green</span><span class="o">,</span> <span class="n">blue</span><span class="o">};</span>
        <span class="k">return</span> <span class="n">rgbArr</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">double</span> <span class="nf">manhattanDistance</span><span class="o">(</span><span class="kt">int</span> <span class="n">a0</span><span class="o">,</span> <span class="kt">int</span> <span class="n">a1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b0</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">c0</span><span class="o">,</span> <span class="kt">int</span> <span class="n">c1</span><span class="o">){</span>
        <span class="kt">double</span> <span class="n">da</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">a0</span> <span class="o">-</span> <span class="n">a1</span><span class="o">);</span>
        <span class="kt">double</span> <span class="n">db</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">b0</span> <span class="o">-</span> <span class="n">b1</span><span class="o">);</span>
        <span class="kt">double</span> <span class="n">dc</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">c0</span> <span class="o">-</span> <span class="n">c1</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">da</span><span class="o">+</span><span class="n">db</span><span class="o">+</span><span class="n">dc</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">double</span> <span class="nf">rgbDistance</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">){</span>
        <span class="kt">int</span>  <span class="n">red</span>   <span class="o">=</span> <span class="o">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="o">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="o">;</span>
        <span class="kt">int</span>  <span class="n">green</span> <span class="o">=</span> <span class="o">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="o">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="o">;</span>
        <span class="kt">int</span>  <span class="n">blue</span>  <span class="o">=</span>  <span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="o">;</span>
        <span class="kt">int</span>  <span class="n">red_2</span>   <span class="o">=</span> <span class="o">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="o">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="o">;</span>
        <span class="kt">int</span>  <span class="n">green_2</span> <span class="o">=</span> <span class="o">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="o">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="o">;</span>
        <span class="kt">int</span>  <span class="n">blue_2</span>  <span class="o">=</span>  <span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="o">;</span>

        <span class="kt">double</span> <span class="n">da</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">red</span> <span class="o">-</span><span class="n">red_2</span><span class="o">);</span>
        <span class="kt">double</span> <span class="n">db</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">green</span> <span class="o">-</span> <span class="n">green_2</span><span class="o">);</span>
        <span class="kt">double</span> <span class="n">dc</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">blue</span> <span class="o">-</span> <span class="n">blue_2</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">da</span><span class="o">+</span><span class="n">db</span><span class="o">+</span><span class="n">dc</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Having this take 80ms for three colors led me into trying something alternative at the time. It has been a long time since I have used Java more than the usual basics and I found out about RecursiveTask. I decided to give it a try. The idea was to split the image into four parts as subtaks until I got to a pixel level. Then start joining the results based on certain conditions. If at least three of the parts were a match, I would continue to return 1. Otherwise I would build pieces of blobs that I would then stick together at the end. This did not go well. I ended up with multiple java.util.concurrent.CancellationException. I went for the traditional fork/join and I doubt using Future would have helped in any way. This test was in the end a terrible failure.</p>

<p>Afterwards I decided to try splitting the image processing into a more reasonable number of threads, four. Although this did improve the runtime a bit, it wasn’t enough. By this time I had already dug into getting something running on Android. I had already tested the camera2 API and I decided to make a few more changes for my new class. I decided to receive the data as a one dimensional array (I decded to not care about the padding and other image stuff, for the moment), I added splitting into multiple threads on a row level (processing in order in the array could potentially help reduce the number of cache faults and thus increase performance), I added a minimum size for width and height of a blob, I process rows first, encoding 64 columns into one long to save memory, I added counters for row level and column level matches to allow skipping rows/columns without any possible blobs when I process the columns, I skip one row and one column at a time to only process number_of_pixels/4 (I later realized that with the introduction of the minimum size I could have skipped many more columns if there was no match) and I keep track of the matched color to avoid looping colors when I am checking for continuity of my last match. For a cold run, the runtime with 3 colors is 20ms on a single thread. When I ran my code with two threads, cold runtime was down to 15ms, but I realized I have some bugs. Since the single threaded performance would allow me 50 FPS I decided to leave it as is.</p>

<p>Result (Matching colors are [0,255,195],[255,0,192],[0,24,255]):</p>

<p><img src="/assets/images/led_graph_bar/foundSplit.png" alt="Sample Image" /></p>

<p>The code:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FastBlobFinderSkip</span> <span class="o">{</span>
    <span class="kt">int</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">width</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">height</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">pixelStride</span><span class="o">;</span>
    <span class="kt">int</span><span class="o">[][]</span> <span class="n">colors</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">minSize</span> <span class="o">=</span> <span class="mi">32</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">masklen</span><span class="o">;</span>
    <span class="kt">long</span> <span class="n">maskLeft</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">pixels_w</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">pixels_h</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">column_width</span> <span class="o">=</span> <span class="mi">128</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">FastBlobFinderSkip</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">,</span> <span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">,</span> <span class="kt">int</span> <span class="n">pixelStride</span><span class="o">,</span> <span class="kt">int</span><span class="o">[][]</span> <span class="n">colors</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bytes</span> <span class="o">=</span> <span class="n">bytes</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">width</span> <span class="o">=</span> <span class="n">width</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">height</span> <span class="o">=</span> <span class="n">height</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">pixelStride</span> <span class="o">=</span> <span class="n">pixelStride</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">colors</span> <span class="o">=</span> <span class="n">colors</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">masklen</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">SIZE</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">maskLeft</span> <span class="o">=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">masklen</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Blob</span><span class="o">&gt;</span> <span class="nf">find</span><span class="o">(</span><span class="kt">int</span> <span class="n">split</span><span class="o">){</span>
        <span class="n">Thread</span><span class="o">[]</span> <span class="n">threads</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">[</span><span class="n">split</span><span class="o">];</span>
        <span class="n">RowCheckerThread</span><span class="o">[]</span> <span class="n">checkers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RowCheckerThread</span><span class="o">[</span><span class="n">split</span><span class="o">];</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="n">split</span><span class="o">;</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">split</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
            <span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">size</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">size</span><span class="o">;</span>
            <span class="n">checkers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RowCheckerThread</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span><span class="n">start</span><span class="o">,</span><span class="n">end</span><span class="o">,</span><span class="n">pixelStride</span><span class="o">,</span><span class="n">width</span><span class="o">,</span><span class="n">height</span><span class="o">,</span><span class="n">colors</span><span class="o">,</span><span class="mi">20</span><span class="o">,</span><span class="mi">32</span><span class="o">);</span>
            <span class="n">threads</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">checkers</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
            <span class="n">threads</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">split</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">threads</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">join</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kt">int</span> <span class="n">masklen</span> <span class="o">=</span> <span class="mi">64</span><span class="o">;</span>
        <span class="kt">long</span><span class="o">[][][]</span> <span class="n">results</span><span class="o">;</span>
        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Blob</span><span class="o">&gt;&gt;</span> <span class="n">blobsMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Blob</span><span class="o">&gt;</span> <span class="n">blobs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="c1">//Bugs in this loop</span>
        <span class="c1">//Row needs to take into account which split we are in for our HashMap</span>
        <span class="c1">//minsize and splitting might make some blobs be left out</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">split</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">checkers</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getResults</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">numColumns</span> <span class="o">=</span> <span class="n">results</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">].</span><span class="na">length</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">numColors</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">numRows</span> <span class="o">=</span> <span class="n">results</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">lastVisitedRow</span><span class="o">;</span>
            <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">color</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">color</span> <span class="o">&lt;</span> <span class="n">numColors</span><span class="o">;</span><span class="n">color</span><span class="o">++){</span>
                <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">column</span> <span class="o">&lt;</span> <span class="n">numColumns</span><span class="o">;</span> <span class="n">column</span><span class="o">++){</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">results</span><span class="o">[</span><span class="n">color</span><span class="o">][</span><span class="n">numRows</span><span class="o">][</span><span class="n">column</span><span class="o">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">)</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">numRows</span><span class="o">;</span><span class="n">row</span><span class="o">++){</span>
                        <span class="k">if</span><span class="o">(</span><span class="n">results</span><span class="o">[</span><span class="n">color</span><span class="o">][</span><span class="n">row</span><span class="o">][</span><span class="n">numColumns</span><span class="o">]</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
                            <span class="k">continue</span><span class="o">;</span>
                        <span class="n">lastVisitedRow</span> <span class="o">=</span> <span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
                        <span class="kt">long</span> <span class="n">aproximateBlob</span> <span class="o">=</span> <span class="n">results</span><span class="o">[</span><span class="n">color</span><span class="o">][</span><span class="n">row</span><span class="o">][</span><span class="n">column</span><span class="o">];</span>
                        <span class="k">while</span> <span class="o">((</span><span class="n">lastVisitedRow</span> <span class="o">&lt;</span> <span class="o">(</span><span class="n">numRows</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span> <span class="o">&amp;&amp;</span> <span class="o">((</span><span class="n">results</span><span class="o">[</span><span class="n">color</span><span class="o">][</span><span class="n">lastVisitedRow</span><span class="o">+</span><span class="mi">1</span><span class="o">][</span><span class="n">column</span><span class="o">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">))){</span>
                            <span class="n">aproximateBlob</span> <span class="o">|=</span> <span class="n">results</span><span class="o">[</span><span class="n">color</span><span class="o">][</span><span class="n">lastVisitedRow</span><span class="o">][</span><span class="n">column</span><span class="o">];</span>
                            <span class="n">lastVisitedRow</span><span class="o">++;</span>
                        <span class="o">}</span>
                        <span class="k">if</span><span class="o">(</span><span class="n">lastVisitedRow</span> <span class="o">-</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">minSize</span><span class="o">/</span><span class="mi">2</span><span class="o">){</span>
                            <span class="n">row</span> <span class="o">=</span> <span class="n">lastVisitedRow</span><span class="o">;</span>
                            <span class="k">continue</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="kt">int</span> <span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                        <span class="kt">int</span> <span class="n">right</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
                        <span class="kt">long</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">|</span> <span class="n">maskLeft</span><span class="o">;</span>
                        <span class="c1">//Depending on the ratio of minSize / maskLen we can have</span>
                        <span class="c1">//more than 1 partition, so it is not possible to do a more</span>
                        <span class="c1">//efficient check, will need to loop</span>
                        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">bitPosition</span> <span class="o">=</span> <span class="n">masklen</span><span class="o">;</span> <span class="n">bitPosition</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span><span class="n">bitPosition</span><span class="o">--){</span>
                            <span class="n">right</span><span class="o">++;</span>
                            <span class="kt">long</span> <span class="n">current</span> <span class="o">=</span> <span class="n">aproximateBlob</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="o">;</span>
                            <span class="k">if</span><span class="o">(</span><span class="n">current</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
                                <span class="k">if</span><span class="o">(</span><span class="n">right</span> <span class="o">&gt;</span> <span class="n">left</span><span class="o">){</span>
                                    <span class="kt">int</span> <span class="n">blob_start_y</span> <span class="o">=</span> <span class="n">row</span> <span class="o">*</span> <span class="n">pixels_h</span><span class="o">;</span>
                                    <span class="kt">int</span> <span class="n">blob_start_x</span> <span class="o">=</span> <span class="o">(</span><span class="n">column</span> <span class="o">*</span> <span class="n">column_width</span><span class="o">)</span> <span class="o">+</span> <span class="n">left</span> <span class="o">*</span> <span class="n">pixels_w</span><span class="o">;</span>
                                    <span class="kt">int</span> <span class="n">blob_end_y</span> <span class="o">=</span> <span class="n">blob_start_y</span> <span class="o">+</span> <span class="o">(</span><span class="n">lastVisitedRow</span> <span class="o">-</span> <span class="n">row</span><span class="o">)</span> <span class="o">*</span> <span class="n">pixels_h</span><span class="o">;</span>
                                    <span class="kt">int</span> <span class="n">blob_end_x</span> <span class="o">=</span> <span class="o">(</span><span class="n">column</span> <span class="o">*</span> <span class="n">column_width</span><span class="o">)</span> <span class="o">+</span> <span class="n">right</span> <span class="o">*</span> <span class="n">pixels_w</span><span class="o">;</span>
                                    <span class="n">Blob</span> <span class="n">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Blob</span><span class="o">();</span>
                                    <span class="n">blob</span><span class="o">.</span><span class="na">setPosition</span><span class="o">(</span><span class="n">blob_start_x</span> <span class="o">+</span> <span class="o">(</span><span class="n">blob_end_x</span> <span class="o">-</span> <span class="n">blob_start_x</span><span class="o">)/</span><span class="mi">2</span><span class="o">,</span> <span class="n">blob_start_y</span> <span class="o">+</span> <span class="o">(</span><span class="n">blob_end_y</span> <span class="o">-</span> <span class="n">blob_start_y</span><span class="o">)/</span><span class="mi">2</span><span class="o">);</span>
                                    <span class="n">blob</span><span class="o">.</span><span class="na">setHeight</span><span class="o">(</span><span class="n">blob_end_y</span><span class="o">-</span><span class="n">blob_start_y</span><span class="o">);</span>
                                    <span class="n">blob</span><span class="o">.</span><span class="na">setWidth</span><span class="o">(</span><span class="n">blob_end_x</span><span class="o">-</span><span class="n">blob_start_x</span><span class="o">);</span>
                                    <span class="n">blob</span><span class="o">.</span><span class="na">setColorIndex</span><span class="o">(</span><span class="n">color</span><span class="o">);</span>
                                    <span class="k">if</span><span class="o">(!</span><span class="n">blobsMap</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">blob_start_x</span><span class="o">)){</span>
                                        <span class="n">blobsMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">blob_start_x</span><span class="o">,</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Blob</span><span class="o">&gt;());</span>
                                    <span class="o">}</span>
                                    <span class="n">blobsMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">blob_start_x</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="n">blob</span><span class="o">);</span>
                                <span class="o">}</span>
                                <span class="n">left</span> <span class="o">=</span> <span class="n">right</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="n">mask</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="n">lastVisitedRow</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">Set</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">blobsMap</span><span class="o">.</span><span class="na">keySet</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">keysList</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
        <span class="n">Collections</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">keysList</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Integer</span> <span class="nl">k:</span> <span class="n">keysList</span><span class="o">){</span>
            <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Blob</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">blobsMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">k</span><span class="o">);</span>
            <span class="k">for</span><span class="o">(</span><span class="n">Blob</span> <span class="nl">element:</span> <span class="n">list</span><span class="o">){</span>
                <span class="kt">int</span> <span class="n">lookup</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">getPosition</span><span class="o">()[</span><span class="mi">0</span><span class="o">]</span> <span class="o">+</span> <span class="n">element</span><span class="o">.</span><span class="na">getWidth</span><span class="o">()/</span><span class="mi">2</span><span class="o">;</span>
                <span class="k">if</span><span class="o">(!</span><span class="n">blobsMap</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">lookup</span><span class="o">))</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
                <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Blob</span><span class="o">&gt;</span> <span class="n">foundList</span> <span class="o">=</span> <span class="n">blobsMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">lookup</span><span class="o">);</span>
                <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">foundList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span><span class="n">index</span><span class="o">++){</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">element</span><span class="o">.</span><span class="na">getColorIndex</span><span class="o">()</span> <span class="o">!=</span> <span class="n">foundList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">).</span><span class="na">getColorIndex</span><span class="o">())</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="kt">int</span> <span class="n">current_y_start</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">getPosition</span><span class="o">()[</span><span class="mi">1</span><span class="o">]</span> <span class="o">-</span> <span class="n">element</span><span class="o">.</span><span class="na">getHeight</span><span class="o">()/</span><span class="mi">2</span><span class="o">;</span>
                    <span class="kt">int</span> <span class="n">current_y_end</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">getPosition</span><span class="o">()[</span><span class="mi">1</span><span class="o">]</span> <span class="o">+</span> <span class="n">element</span><span class="o">.</span><span class="na">getHeight</span><span class="o">()/</span><span class="mi">2</span><span class="o">;</span>
                    <span class="kt">int</span> <span class="n">found_y_start</span> <span class="o">=</span> <span class="n">foundList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">).</span><span class="na">getPosition</span><span class="o">()[</span><span class="mi">1</span><span class="o">]</span> <span class="o">-</span> <span class="n">foundList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">).</span><span class="na">getHeight</span><span class="o">()/</span><span class="mi">2</span><span class="o">;</span>
                    <span class="kt">int</span> <span class="n">found_y_end</span> <span class="o">=</span> <span class="n">foundList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">).</span><span class="na">getPosition</span><span class="o">()[</span><span class="mi">1</span><span class="o">]</span> <span class="o">-</span> <span class="n">foundList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">).</span><span class="na">getHeight</span><span class="o">()/</span><span class="mi">2</span><span class="o">;</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">found_y_start</span> <span class="o">&lt;=</span> <span class="n">current_y_end</span> <span class="o">&amp;&amp;</span> <span class="n">current_y_start</span> <span class="o">&lt;=</span> <span class="n">found_y_end</span><span class="o">){</span>
                        <span class="k">if</span><span class="o">(</span><span class="n">found_y_start</span> <span class="o">&lt;</span> <span class="n">current_y_start</span><span class="o">)</span>
                            <span class="n">current_y_start</span> <span class="o">=</span> <span class="n">found_y_start</span><span class="o">;</span>
                        <span class="k">if</span><span class="o">(</span><span class="n">found_y_end</span> <span class="o">&gt;</span> <span class="n">current_y_end</span><span class="o">)</span>
                            <span class="n">current_y_end</span> <span class="o">=</span> <span class="n">found_y_end</span><span class="o">;</span>
                        <span class="kt">int</span> <span class="n">current_x_start</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">getPosition</span><span class="o">()[</span><span class="mi">0</span><span class="o">]</span> <span class="o">-</span> <span class="n">element</span><span class="o">.</span><span class="na">getWidth</span><span class="o">()/</span><span class="mi">2</span><span class="o">;</span>
                        <span class="kt">int</span> <span class="n">current_x_end</span> <span class="o">=</span> <span class="n">foundList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">).</span><span class="na">getPosition</span><span class="o">()[</span><span class="mi">0</span><span class="o">]</span> <span class="o">+</span> <span class="n">foundList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">).</span><span class="na">getWidth</span><span class="o">()/</span><span class="mi">2</span><span class="o">;</span>
                        <span class="n">element</span><span class="o">.</span><span class="na">setWidth</span><span class="o">(</span><span class="n">current_x_end</span> <span class="o">-</span> <span class="n">current_x_start</span><span class="o">);</span>
                        <span class="n">element</span><span class="o">.</span><span class="na">setHeight</span><span class="o">(</span><span class="n">current_y_end</span><span class="o">-</span><span class="n">current_y_start</span><span class="o">);</span>
                        <span class="n">element</span><span class="o">.</span><span class="na">setPosition</span><span class="o">(</span><span class="n">current_x_start</span> <span class="o">+</span> <span class="o">(</span><span class="n">current_x_end</span> <span class="o">-</span> <span class="n">current_x_start</span><span class="o">)/</span><span class="mi">2</span><span class="o">,</span><span class="n">current_y_start</span> <span class="o">+</span> <span class="o">(</span><span class="n">current_y_end</span><span class="o">-</span><span class="n">current_y_start</span><span class="o">)/</span><span class="mi">2</span><span class="o">);</span>
                        <span class="n">match</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">if</span><span class="o">(</span><span class="n">match</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span>
                    <span class="n">foundList</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">match</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Integer</span> <span class="nl">key:</span><span class="n">blobsMap</span><span class="o">.</span><span class="na">keySet</span><span class="o">()){</span>
            <span class="k">for</span><span class="o">(</span><span class="n">Blob</span> <span class="nl">blob:</span> <span class="n">blobsMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">)){</span>
                <span class="n">blobs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">blob</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">blobs</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">class</span> <span class="nc">RowCheckerThread</span> <span class="kd">implements</span> <span class="n">Runnable</span><span class="o">{</span>
        <span class="kt">long</span><span class="o">[][][]</span> <span class="n">results</span><span class="o">;</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">row_start</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">row_end</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">pixelStride</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">width</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">height</span><span class="o">;</span>
        <span class="kt">int</span><span class="o">[][]</span> <span class="n">colors</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">numColors</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">minSize</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">masklen</span> <span class="o">=</span> <span class="mi">64</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">maxColorDistance</span> <span class="o">=</span> <span class="mi">20</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">numElements</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">colCount</span><span class="o">[][];</span>

        <span class="kd">public</span> <span class="nf">RowCheckerThread</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">,</span> <span class="kt">int</span> <span class="n">row_start</span><span class="o">,</span> <span class="kt">int</span> <span class="n">row_end</span><span class="o">,</span> <span class="kt">int</span> <span class="n">pixelStride</span><span class="o">,</span> <span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">,</span> <span class="kt">int</span><span class="o">[][]</span> <span class="n">colors</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxColorDistance</span><span class="o">,</span> <span class="kt">int</span> <span class="n">minSize</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">bytes</span> <span class="o">=</span> <span class="n">bytes</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">row_start</span> <span class="o">=</span> <span class="n">row_start</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">row_end</span> <span class="o">=</span> <span class="n">row_end</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">pixelStride</span> <span class="o">=</span> <span class="n">pixelStride</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">width</span> <span class="o">=</span> <span class="n">width</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">height</span> <span class="o">=</span> <span class="n">height</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">colors</span> <span class="o">=</span> <span class="n">colors</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">maxColorDistance</span> <span class="o">=</span> <span class="n">maxColorDistance</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">minSize</span> <span class="o">=</span> <span class="n">minSize</span> <span class="o">&lt;</span> <span class="n">masklen</span><span class="o">/</span><span class="mi">2</span> <span class="o">?</span> <span class="n">masklen</span><span class="o">/</span><span class="mi">2</span> <span class="o">:</span> <span class="n">minSize</span><span class="o">;</span>
            <span class="n">numColors</span>  <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">numElements</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">Math</span><span class="o">.</span><span class="na">ceil</span><span class="o">((</span><span class="kt">double</span><span class="o">)</span><span class="n">width</span><span class="o">/(</span><span class="kt">double</span><span class="o">)</span><span class="k">this</span><span class="o">.</span><span class="na">masklen</span><span class="o">)/</span><span class="mi">2</span><span class="o">;</span>
            <span class="n">results</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">long</span><span class="o">[</span><span class="n">numColors</span><span class="o">][(</span><span class="n">row_end</span><span class="o">-</span><span class="n">row_start</span><span class="o">)/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="o">][</span><span class="n">numElements</span> <span class="o">+</span> <span class="mi">1</span><span class="o">];</span>
            <span class="n">colCount</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">long</span><span class="o">[</span><span class="n">numColors</span><span class="o">][</span><span class="n">numElements</span><span class="o">];</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
            <span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="kt">long</span><span class="o">[]</span> <span class="n">mask</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">long</span><span class="o">[</span><span class="n">numColors</span><span class="o">];</span>
            <span class="kt">long</span> <span class="n">clearMask</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>
            <span class="kt">long</span> <span class="n">prevClearMask</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">prevCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="kt">long</span> <span class="n">setter</span> <span class="o">=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="mi">63</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
            <span class="kt">boolean</span> <span class="n">change</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">_y</span><span class="o">;</span>
            <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">row_start</span><span class="o">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="o">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">row_end</span><span class="o">)/</span><span class="mi">2</span><span class="o">;</span> <span class="n">y</span><span class="o">++){</span>
                <span class="n">_y</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="mi">2</span><span class="o">;</span>
                <span class="k">if</span><span class="o">(</span><span class="n">match</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">){</span>
                    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numColors</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
                        <span class="k">if</span><span class="o">(</span><span class="n">rgbArrayDistanceLessThanOrEqual</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span><span class="n">pixelStride</span><span class="o">,</span><span class="n">_y</span><span class="o">,</span><span class="n">colors</span><span class="o">[</span><span class="n">i</span><span class="o">],</span><span class="n">maxColorDistance</span><span class="o">)){</span>
                            <span class="n">match</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
                            <span class="n">counter</span><span class="o">++;</span>
                            <span class="n">mask</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">|=</span> <span class="n">setter</span><span class="o">;</span>
                            <span class="n">clearMask</span> <span class="o">|=</span> <span class="n">setter</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">else</span><span class="o">{</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">rgbArrayDistanceLessThanOrEqual</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span><span class="n">pixelStride</span><span class="o">,</span><span class="n">_y</span><span class="o">,</span><span class="n">colors</span><span class="o">[</span><span class="n">match</span><span class="o">],</span><span class="n">maxColorDistance</span><span class="o">)){</span>
                        <span class="n">counter</span><span class="o">++;</span>
                        <span class="n">mask</span><span class="o">[</span><span class="n">match</span><span class="o">]</span> <span class="o">|=</span> <span class="n">setter</span><span class="o">;</span>
                        <span class="n">clearMask</span> <span class="o">|=</span> <span class="n">setter</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="k">if</span><span class="o">(</span><span class="n">counter</span> <span class="o">+</span> <span class="n">prevCount</span> <span class="o">&lt;</span> <span class="n">minSize</span><span class="o">/</span><span class="mi">2</span><span class="o">){</span>
                            <span class="n">mask</span><span class="o">[</span><span class="n">match</span><span class="o">]</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                            <span class="k">if</span><span class="o">(</span><span class="n">change</span> <span class="o">&amp;&amp;</span> <span class="n">prevClearMask</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">prevClearMask</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">){</span>
                                <span class="kt">int</span> <span class="n">rowPos</span> <span class="o">=</span> <span class="n">_y</span> <span class="o">%</span> <span class="n">width</span><span class="o">;</span>
                                <span class="kt">int</span> <span class="n">mod</span> <span class="o">=</span> <span class="n">rowPos</span> <span class="o">%</span> <span class="n">masklen</span><span class="o">;</span>
                                <span class="kt">int</span> <span class="n">currentColumn</span> <span class="o">=</span> <span class="o">((</span><span class="n">rowPos</span> <span class="o">-</span> <span class="n">mod</span><span class="o">)/</span> <span class="n">masklen</span><span class="o">)/</span><span class="mi">2</span><span class="o">;</span>
                                <span class="k">if</span><span class="o">(</span><span class="n">currentColumn</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">)</span>
                                    <span class="n">currentColumn</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                                <span class="k">try</span><span class="o">{</span>
                                    <span class="n">results</span><span class="o">[</span><span class="n">match</span><span class="o">][</span><span class="n">row</span><span class="o">][</span><span class="n">currentColumn</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span> <span class="o">^=</span> <span class="n">prevClearMask</span><span class="o">;</span>
                                    <span class="k">if</span><span class="o">(</span><span class="n">results</span><span class="o">[</span><span class="n">match</span><span class="o">][</span><span class="n">row</span><span class="o">][</span><span class="n">currentColumn</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
                                        <span class="n">results</span><span class="o">[</span><span class="n">match</span><span class="o">][</span><span class="n">row</span><span class="o">][</span><span class="n">currentColumn</span><span class="o">]</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                                        <span class="n">results</span><span class="o">[</span><span class="n">match</span><span class="o">][</span><span class="n">row</span><span class="o">][</span><span class="n">numElements</span><span class="o">]--;</span>
                                        <span class="n">colCount</span><span class="o">[</span><span class="n">match</span><span class="o">][</span><span class="n">currentColumn</span><span class="o">-</span><span class="mi">1</span><span class="o">]--;</span>
                                    <span class="o">}</span>
                                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ArrayIndexOutOfBoundsException</span> <span class="n">e</span><span class="o">){</span>
                                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                                <span class="o">}</span>
                                <span class="n">change</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                        <span class="n">prevClearMask</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                        <span class="n">clearMask</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                        <span class="n">prevCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numColors</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
                            <span class="k">if</span><span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">match</span><span class="o">)</span>
                                <span class="k">continue</span><span class="o">;</span>
                            <span class="k">if</span><span class="o">(</span><span class="n">rgbArrayDistanceLessThanOrEqual</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span><span class="n">pixelStride</span><span class="o">,</span><span class="n">_y</span><span class="o">,</span><span class="n">colors</span><span class="o">[</span><span class="n">i</span><span class="o">],</span><span class="n">maxColorDistance</span><span class="o">)){</span>
                                <span class="n">match</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
                                <span class="n">counter</span><span class="o">++;</span>
                                <span class="n">mask</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">|=</span> <span class="n">setter</span><span class="o">;</span>
                                <span class="n">clearMask</span> <span class="o">|=</span> <span class="n">setter</span><span class="o">;</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                        <span class="n">match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">setter</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">next</span> <span class="o">=</span> <span class="n">_y</span><span class="o">+</span><span class="mi">2</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">nextRow</span> <span class="o">=</span> <span class="n">next</span><span class="o">/</span><span class="mi">2</span> <span class="o">%</span> <span class="n">width</span><span class="o">;</span>
                <span class="k">if</span><span class="o">(</span> <span class="n">nextRow</span> <span class="o">%</span> <span class="n">masklen</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
                    <span class="n">setter</span> <span class="o">=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="mi">63</span><span class="o">;</span>
                    <span class="n">prevCount</span> <span class="o">=</span> <span class="n">counter</span><span class="o">;</span>
                    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

                    <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">nextRow</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">numElements</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">(</span><span class="n">nextRow</span><span class="o">/</span> <span class="n">masklen</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">%</span> <span class="n">numElements</span><span class="o">;</span>

                    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numColors</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
                        <span class="n">results</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">row</span><span class="o">][</span><span class="n">pos</span><span class="o">]</span> <span class="o">|=</span> <span class="n">mask</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
                        <span class="k">if</span><span class="o">(</span><span class="n">mask</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">){</span>
                            <span class="n">results</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">row</span><span class="o">][</span><span class="n">numElements</span><span class="o">]++;</span>
                            <span class="n">colCount</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">pos</span><span class="o">]++;</span>
                        <span class="o">}</span>
                        <span class="n">mask</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">change</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">match</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">){</span>
                        <span class="n">prevClearMask</span> <span class="o">=</span> <span class="n">clearMask</span><span class="o">;</span>
                        <span class="n">clearMask</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">if</span><span class="o">(</span><span class="n">nextRow</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">match</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">prevCount</span> <span class="o">&lt;</span> <span class="n">minSize</span><span class="o">/</span><span class="mi">2</span><span class="o">){</span>
                        <span class="n">results</span><span class="o">[</span><span class="n">match</span><span class="o">][</span><span class="n">row</span><span class="o">][</span><span class="n">numElements</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span> <span class="o">^=</span> <span class="n">prevClearMask</span><span class="o">;</span>
                        <span class="k">if</span><span class="o">(</span><span class="n">results</span><span class="o">[</span><span class="n">match</span><span class="o">][</span><span class="n">row</span><span class="o">][</span><span class="n">numElements</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
                            <span class="n">results</span><span class="o">[</span><span class="n">match</span><span class="o">][</span><span class="n">row</span><span class="o">][</span><span class="n">numElements</span><span class="o">]--;</span>
                            <span class="n">colCount</span><span class="o">[</span><span class="n">match</span><span class="o">][</span><span class="n">numElements</span> <span class="o">-</span><span class="mi">1</span><span class="o">]--;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                    <span class="n">prevCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
                    <span class="n">clearMask</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>
                    <span class="n">prevClearMask</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>
                    <span class="n">row</span><span class="o">++;</span>
                    <span class="n">change</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="n">y</span> <span class="o">+=</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">color</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">color</span><span class="o">&lt;</span><span class="n">numColors</span><span class="o">;</span><span class="n">color</span><span class="o">++){</span>
                <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">column</span> <span class="o">&lt;</span> <span class="n">numElements</span><span class="o">;</span><span class="n">column</span><span class="o">++){</span>
                    <span class="n">results</span><span class="o">[</span><span class="n">color</span><span class="o">][(</span><span class="n">row_end</span><span class="o">-</span><span class="n">row_start</span><span class="o">)/</span><span class="mi">2</span><span class="o">][</span><span class="n">column</span><span class="o">]</span> <span class="o">=</span> <span class="n">colCount</span><span class="o">[</span><span class="n">color</span><span class="o">][</span><span class="n">column</span><span class="o">];</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">long</span><span class="o">[][][]</span> <span class="nf">getResults</span><span class="o">(){</span>
            <span class="k">return</span> <span class="n">results</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">rgbArrayDistanceLessThanOrEqual</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">,</span> <span class="kt">int</span> <span class="n">pixelStride</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">color</span><span class="o">,</span> <span class="kt">int</span> <span class="n">distance</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">pixelStride</span> <span class="o">==</span> <span class="mi">1</span><span class="o">){</span>
            <span class="kt">int</span> <span class="n">_color</span> <span class="o">=</span> <span class="o">(</span><span class="n">color</span><span class="o">[</span><span class="mi">0</span><span class="o">]&lt;&lt;</span><span class="mi">16</span><span class="o">)</span> <span class="o">|</span> <span class="o">(</span><span class="n">color</span><span class="o">[</span><span class="mi">1</span><span class="o">]&lt;&lt;</span><span class="mi">8</span><span class="o">)</span> <span class="o">|</span> <span class="n">color</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">rgbDistance</span><span class="o">(</span><span class="n">bytes</span><span class="o">[</span><span class="n">position</span><span class="o">],</span> <span class="n">_color</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">distance</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">_shift</span> <span class="o">=</span> <span class="n">pixelStride</span> <span class="o">-</span> <span class="mi">3</span><span class="o">;</span>
        <span class="kt">double</span> <span class="n">rsq</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">pow</span><span class="o">(</span><span class="n">bytes</span><span class="o">[</span><span class="n">position</span><span class="o">+</span><span class="n">_shift</span><span class="o">]</span> <span class="o">-</span> <span class="n">color</span><span class="o">[</span><span class="n">_shift</span><span class="o">],</span> <span class="mi">2</span><span class="o">);</span>
        <span class="kt">double</span> <span class="n">gsq</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">pow</span><span class="o">(</span><span class="n">bytes</span><span class="o">[</span><span class="n">position</span><span class="o">+</span><span class="n">_shift</span><span class="o">+</span><span class="mi">1</span><span class="o">]</span> <span class="o">-</span> <span class="n">color</span><span class="o">[</span><span class="n">_shift</span><span class="o">+</span><span class="mi">1</span><span class="o">],</span> <span class="mi">2</span><span class="o">);</span>
        <span class="kt">double</span> <span class="n">bsq</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">pow</span><span class="o">(</span><span class="n">bytes</span><span class="o">[</span><span class="n">position</span><span class="o">+</span><span class="n">_shift</span><span class="o">+</span><span class="mi">2</span><span class="o">]</span> <span class="o">-</span> <span class="n">color</span><span class="o">[</span><span class="n">_shift</span><span class="o">+</span><span class="mi">2</span><span class="o">],</span> <span class="mi">2</span><span class="o">);</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">Math</span><span class="o">.</span><span class="na">sqrt</span><span class="o">(</span><span class="n">rsq</span><span class="o">+</span><span class="n">gsq</span><span class="o">+</span><span class="n">bsq</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">distance</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">double</span> <span class="nf">rgbDistance</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">){</span>
        <span class="kt">int</span>  <span class="n">red</span>   <span class="o">=</span> <span class="o">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="o">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="o">;</span>
        <span class="kt">int</span>  <span class="n">green</span> <span class="o">=</span> <span class="o">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="o">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="o">;</span>
        <span class="kt">int</span>  <span class="n">blue</span>  <span class="o">=</span>  <span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="o">;</span>
        <span class="kt">int</span>  <span class="n">red_2</span>   <span class="o">=</span> <span class="o">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="o">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="o">;</span>
        <span class="kt">int</span>  <span class="n">green_2</span> <span class="o">=</span> <span class="o">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="o">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="o">;</span>
        <span class="kt">int</span>  <span class="n">blue_2</span>  <span class="o">=</span>  <span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="o">;</span>
        <span class="kt">double</span> <span class="n">rsq</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">pow</span><span class="o">(</span><span class="n">red_2</span> <span class="o">-</span> <span class="n">red</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
        <span class="kt">double</span> <span class="n">gsq</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">pow</span><span class="o">(</span><span class="n">green_2</span><span class="o">-</span><span class="n">green</span><span class="o">,</span><span class="mi">2</span><span class="o">);</span>
        <span class="kt">double</span> <span class="n">bsq</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">pow</span><span class="o">(</span><span class="n">blue_2</span><span class="o">-</span><span class="n">blue</span><span class="o">,</span><span class="mi">2</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">Math</span><span class="o">.</span><span class="na">sqrt</span><span class="o">(</span><span class="n">rsq</span><span class="o">+</span><span class="n">gsq</span><span class="o">+</span><span class="n">bsq</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>I went on to modify the Camera2 API example to test on my phone. I did not think that my phone’s camera could disappoint me more (bad photo quality), but my code would give me an exception on my Honor 10. Searching on Google, wasn’t very helpful. The issue was that even though I was requesting the image as ARGB_8888( from the Config enum in the Bitmap class), when reading from the ImageReader I was being told the format I got didn’t match what I requested. Upon investigating a bit more, it seems that they are using some private format, but this is only conjecture. I decided to test on a Moto G5 Plus and everything seemed to work, more or less. Images from my camera weren’t as perfect as the test images I quickly made using Krita. I haven’t tested with leds yet and set my matching colors to perfect red, green and blue, but I may test changing my code to compare with the last match instead of the color from my list of colors.</p>

<p>I did a number of changes to the sample code, but roughly the important pieces are:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java">  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">openCamera</span><span class="o">(</span><span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ContextCompat</span><span class="o">.</span><span class="na">checkSelfPermission</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="n">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">CAMERA</span><span class="o">)</span>
                <span class="o">!=</span> <span class="n">PackageManager</span><span class="o">.</span><span class="na">PERMISSION_GRANTED</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">requestCameraPermission</span><span class="o">();</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">setUpCameraOutputs</span><span class="o">(</span><span class="n">width</span><span class="o">,</span> <span class="n">height</span><span class="o">);</span>
        <span class="n">Activity</span> <span class="n">activity</span> <span class="o">=</span> <span class="n">getActivity</span><span class="o">();</span>
        <span class="n">CameraManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="o">(</span><span class="n">CameraManager</span><span class="o">)</span> <span class="n">activity</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">CAMERA_SERVICE</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">mCameraOpenCloseLock</span><span class="o">.</span><span class="na">tryAcquire</span><span class="o">(</span><span class="mi">2500</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Time out waiting to lock camera opening."</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">CameraCharacteristics</span> <span class="n">characteristics</span> <span class="o">=</span>
                    <span class="n">manager</span><span class="o">.</span><span class="na">getCameraCharacteristics</span><span class="o">(</span><span class="n">mCameraId</span><span class="o">);</span>
            <span class="n">StreamConfigurationMap</span> <span class="n">map</span> <span class="o">=</span>
                    <span class="n">characteristics</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">CameraCharacteristics</span><span class="o">.</span><span class="na">SCALER_STREAM_CONFIGURATION_MAP</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">map</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"No StreamConfigurationMap available"</span><span class="o">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">Size</span><span class="o">[]</span> <span class="n">sizes</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">getOutputSizes</span><span class="o">(</span><span class="n">Allocation</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">sizes</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="n">Size</span> <span class="n">videoSize</span> <span class="o">=</span> <span class="n">chooseOptimalSize</span><span class="o">(</span><span class="n">sizes</span><span class="o">,</span> <span class="n">width</span><span class="o">,</span> <span class="n">height</span><span class="o">,</span> <span class="n">MAX_PREVIEW_WIDTH</span><span class="o">,</span> <span class="n">MAX_PREVIEW_HEIGHT</span><span class="o">,</span><span class="n">sizes</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
            <span class="n">Size</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">sizes</span><span class="o">[</span><span class="n">sizes</span><span class="o">.</span><span class="na">length</span><span class="o">-</span><span class="mi">2</span><span class="o">];</span> <span class="c1">//Hardcoded size for testing different sizes</span>
            <span class="n">mImageReader</span> <span class="o">=</span> <span class="n">ImageReader</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">sz</span><span class="o">.</span><span class="na">getWidth</span><span class="o">(),</span>
                    <span class="n">sz</span><span class="o">.</span><span class="na">getHeight</span><span class="o">(),</span>
                    <span class="n">PixelFormat</span><span class="o">.</span><span class="na">RGBA_8888</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span>
            <span class="n">mImageReader</span><span class="o">.</span><span class="na">setOnImageAvailableListener</span><span class="o">(</span><span class="n">mmImageAvailable</span><span class="o">,</span><span class="n">mBackgroundHandler</span><span class="o">);</span>
            <span class="n">mPreviewSize</span> <span class="o">=</span> <span class="n">videoSize</span><span class="o">;</span>
            <span class="n">configureTransform</span><span class="o">(</span><span class="n">width</span><span class="o">,</span> <span class="n">height</span><span class="o">);</span>

            <span class="n">manager</span><span class="o">.</span><span class="na">openCamera</span><span class="o">(</span><span class="n">mCameraId</span><span class="o">,</span> <span class="n">mStateCallback</span><span class="o">,</span> <span class="n">mBackgroundHandler</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CameraAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Interrupted while trying to lock camera opening."</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="n">ImageReader</span><span class="o">.</span><span class="na">OnImageAvailableListener</span> <span class="n">mmImageAvailable</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ImageReader</span><span class="o">.</span><span class="na">OnImageAvailableListener</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onImageAvailable</span><span class="o">(</span><span class="n">ImageReader</span> <span class="n">reader</span><span class="o">)</span> <span class="o">{</span>

            <span class="n">Image</span> <span class="n">image</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">acquireLatestImage</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">image</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="na">getWidth</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="na">getHeight</span><span class="o">();</span>

            <span class="kd">final</span> <span class="n">Image</span><span class="o">.</span><span class="na">Plane</span><span class="o">[]</span> <span class="n">planes</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="na">getPlanes</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">planes</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">planes</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
                <span class="n">ErrorDialog</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">camera_error</span><span class="o">))</span>
                        <span class="o">.</span><span class="na">show</span><span class="o">(</span><span class="n">getChildFragmentManager</span><span class="o">(),</span> <span class="n">FRAGMENT_DIALOG</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="kd">final</span> <span class="n">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">planes</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">getBuffer</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">pixelStride</span> <span class="o">=</span> <span class="n">planes</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">getPixelStride</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">rowStride</span> <span class="o">=</span> <span class="n">planes</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">getRowStride</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">rowPadding</span> <span class="o">=</span> <span class="n">rowStride</span> <span class="o">-</span> <span class="n">pixelStride</span> <span class="o">*</span> <span class="n">width</span><span class="o">;</span>

            <span class="n">Bitmap</span> <span class="n">bitmap</span> <span class="o">=</span> <span class="n">Bitmap</span><span class="o">.</span><span class="na">createBitmap</span><span class="o">(</span><span class="n">width</span> <span class="o">+</span> <span class="n">rowPadding</span> <span class="o">/</span> <span class="n">pixelStride</span><span class="o">,</span> <span class="n">height</span><span class="o">,</span> <span class="n">Bitmap</span><span class="o">.</span><span class="na">Config</span><span class="o">.</span><span class="na">ARGB_8888</span><span class="o">);</span>
            <span class="n">bitmap</span><span class="o">.</span><span class="na">copyPixelsFromBuffer</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
            <span class="n">image</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="kt">int</span><span class="o">[][]</span> <span class="n">colors</span> <span class="o">=</span> <span class="o">{</span> <span class="o">{</span><span class="mi">255</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">},</span> <span class="o">{</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">255</span><span class="o">},</span> <span class="o">{</span><span class="mi">0</span><span class="o">,</span> <span class="mi">255</span><span class="o">,</span> <span class="mi">0</span><span class="o">}</span> <span class="o">};</span>
            <span class="c1">//The data in the byte array from the ByteBuffer was strange</span>
            <span class="c1">//feeling a bit lazy so I'll just get the array from the bitmap</span>
            <span class="c1">//I'll use it anyway to update the ImageView</span>
            <span class="kt">int</span><span class="o">[]</span> <span class="n">arr</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">width</span><span class="o">*</span><span class="n">height</span><span class="o">];</span>
            <span class="n">bitmap</span><span class="o">.</span><span class="na">getPixels</span><span class="o">(</span><span class="n">arr</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">width</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">width</span><span class="o">,</span><span class="n">height</span><span class="o">);</span>
            <span class="n">FastBlobFinderSkip</span> <span class="n">finderSkip</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FastBlobFinderSkip</span><span class="o">(</span><span class="n">arr</span><span class="o">,</span><span class="n">width</span><span class="o">,</span><span class="n">height</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="n">colors</span><span class="o">);</span>
            <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Blob</span><span class="o">&gt;</span> <span class="n">blobs</span> <span class="o">=</span> <span class="n">finderSkip</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
            <span class="k">for</span><span class="o">(</span><span class="n">Blob</span> <span class="nl">blob:</span> <span class="n">blobs</span><span class="o">){</span>
                <span class="kt">int</span><span class="o">[]</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">blob</span><span class="o">.</span><span class="na">getPosition</span><span class="o">();</span>
                <span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="n">blob</span><span class="o">.</span><span class="na">getWidth</span><span class="o">();</span>
                <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">blob</span><span class="o">.</span><span class="na">getHeight</span><span class="o">();</span>
                <span class="n">drawSquare</span><span class="o">(</span><span class="n">bitmap</span><span class="o">,</span> <span class="n">pos</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">pos</span><span class="o">[</span><span class="mi">1</span><span class="o">],</span> <span class="n">w</span><span class="o">,</span> <span class="n">h</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="kt">boolean</span> <span class="n">findBlobs</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">updateImage</span><span class="o">(</span><span class="n">bitmap</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">};</span>
  </code></pre></figure>

<p>This is it for part one. For part two I’ll move on to using an Arduino and testing this code in the conditions it is intended to be used.</p>

  </div><form method="POST"
      action="https://api.staticman.net/v2/entry/mcantureinhard/mcantureinhard.github.io/comments">
      <input name="fields[product]" type="hidden" value="led-camera-decoding-part-one" />
      <input name="options[redirect]" type="hidden" value="http://localhost:4000/led-camera-decoding-part-one/" />
  <div class="form-group">
    <label for="name">Name</label>
    <input type="text" class="form-control" id="comment_name" name="fields[name]" placeholder="Your name">
  </div>
  <div class="form-group">
    <label for="email">Email address (optional)</label>
    <input type="email" class="form-control" id="comment_email" name="fields[email]" placeholder="name@example.com">
  </div>
  <div class="form-group">
    <label for="comment">Comment</label>
    <textarea class="form-control" name="fields[message]" id="comment_comment" rows="3"></textarea>
  </div>
  <button class="btn btn-primary" type="submit">Submit comment</button>
</form>


  <a class="u-url" href="/led-camera-decoding-part-one/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Random code generator</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Random code generator</li><li><a class="u-email" href="mailto:m.cantu.reinhard@gmail.com">m.cantu.reinhard@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/mcantureinhard"><i class="fab fa-github"></i> <span class="username">mcantureinhard</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>From time to time I do little projects at home. Here is the place I&#39;ll write about some of these.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
